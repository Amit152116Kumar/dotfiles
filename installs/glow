#!/usr/bin/env bash
set -euo pipefail

# Debian/Ubuntu installation for Glow (idempotent)

KEYRING_DIR="/etc/apt/keyrings"
KEY_FILE="$KEYRING_DIR/charm.gpg"
LIST_FILE="/etc/apt/sources.list.d/charm.list"

# Ensure keyring directory exists
if [[ ! -d "$KEYRING_DIR" ]]; then
  sudo mkdir -p "$KEYRING_DIR"
fi

# Add GPG key if missing
if [[ ! -f "$KEY_FILE" ]]; then
  curl -fsSL https://repo.charm.sh/apt/gpg.key | sudo gpg --dearmor -o "$KEY_FILE"
fi

# Add repo list if missing
if [[ ! -f "$LIST_FILE" ]] || ! grep -q "repo.charm.sh" "$LIST_FILE"; then
  echo "deb [signed-by=$KEY_FILE] https://repo.charm.sh/apt/ * *" |
    sudo tee "$LIST_FILE" >/dev/null
fi

# Update package index
sudo apt update -y

# Install glow if not already installed
if ! dpkg -s glow >/dev/null 2>&1; then
  sudo apt install -y glow
fi
