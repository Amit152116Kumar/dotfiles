#!/usr/bin/env bash
set -euo pipefail  

# --- Variables ---
DOTFILES_DIR="${DOTFILES_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")/../" >/dev/null 2>&1 && pwd)}"
ZSH_CUSTOM="$HOME/.oh-my-zsh/custom"


# --- Install Zsh ---
if ! command -v zsh >/dev/null 2>&1; then
    echo "Installing Zsh and dependencies..."
    sudo apt update -y
    sudo apt install -y zsh git curl
else
    echo "Zsh already installed."
fi

# --- Install Oh My Zsh ---
if [[ ! -d "$HOME/.oh-my-zsh" ]]; then
    echo "Installing Oh My Zsh..."
    RUNZSH=no KEEP_ZSHRC=yes sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
else
    echo "Oh My Zsh already installed."
fi

# --- Install Powerlevel10k ---
if [[ ! -d "$ZSH_CUSTOM/themes/powerlevel10k" ]]; then
    echo "Installing Powerlevel10k theme..."
    git clone --depth=1 https://github.com/romkatv/powerlevel10k.git "$ZSH_CUSTOM/themes/powerlevel10k"
else
    echo "Powerlevel10k already installed."
fi

# Load the createSymlink function
source "$DOTFILES_DIR/symlink.sh"

# --- Setup Zsh Config ---
echo "Setting up Zsh config..."
createSymlink "$DOTFILES_DIR/env/.zshrc" "$HOME/.zshrc"
createSymlink "$DOTFILES_DIR/env/.zsh" "$HOME/.zsh"
createSymlink "$DOTFILES_DIR/env/.p10k.zsh" "$HOME/.p10k.zsh"

# --- Change default shell ---
current_shell="$(getent passwd "$USER" | cut -d: -f7)"
zsh_path="$(which zsh)"

if [[ "$current_shell" == "$zsh_path" ]]; then
    echo "Zsh is already the default shell."
elif ! grep -q "$zsh_path" /etc/shells; then
    echo "‚ö†Ô∏è $zsh_path is not in /etc/shells. Cannot change default shell."
elif chsh -s "$zsh_path"; then
    echo "‚úÖ Shell changed successfully! Restart your terminal."
else
    echo "‚ùå Failed to change shell. Try manually: chsh -s $zsh_path $USER"
fi

echo "üéâ Zsh setup complete!"
