#!/usr/bin/env bash
set -euo pipefail

# Ensure necessary commands exist
for cmd in curl sudo apt locale-gen; do
	if ! command -v $cmd &>/dev/null; then
		echo "‚ùå $cmd not found. Please install it first."
		exit 1
	fi
done

# --- Set UTF-8 locale ---
echo "üîß Setting locale..."
locale | grep -q "UTF-8" || {
	sudo apt update
	sudo apt install -y locales
	sudo locale-gen en_US en_US.UTF-8
	sudo update-locale LC_ALL=en_US.UTF-8 LANG=en_US.UTF-8
	export LANG=en_US.UTF-8
}

echo "‚úÖ Locale set to:"
locale

# --- Enable universe repository ---
sudo apt install -y software-properties-common
sudo add-apt-repository -y universe

sudo apt update

# --- Get latest ROS APT source ---
ROS_APT_SOURCE_VERSION=$(curl -s https://api.github.com/repos/ros-infrastructure/ros-apt-source/releases/latest |
	grep -F "tag_name" |
	awk -F\" '{print $4}')

if [[ -z "$ROS_APT_SOURCE_VERSION" ]]; then
	echo "‚ùå Failed to fetch latest ROS APT source version"
	exit 1
fi

UBUNTU_CODENAME=$(. /etc/os-release && echo "$VERSION_CODENAME")
ROS_DEB_URL="https://github.com/ros-infrastructure/ros-apt-source/releases/download/${ROS_APT_SOURCE_VERSION}/ros2-apt-source_${ROS_APT_SOURCE_VERSION}.${UBUNTU_CODENAME}_all.deb"

echo "Downloading ROS 2 APT source: $ROS_DEB_URL"
curl -L -o /tmp/ros2-apt-source.deb "$ROS_DEB_URL"

sudo dpkg -i /tmp/ros2-apt-source.deb || {
	echo "‚ùå Failed to install ROS 2 APT source"
	exit 1
}

sudo apt update

# --- Install Python dev and ROS dev tools ---
PY_PKGS=(
	python3-flake8-docstrings
	python3-pip
	python3-pytest-cov
	ros-dev-tools
	python3-flake8-blind-except
	python3-flake8-builtins
	python3-flake8-class-newline
	python3-flake8-comprehensions
	python3-flake8-deprecated
	python3-flake8-import-order
	python3-flake8-quotes
	python3-pytest-repeat
	python3-pytest-rerunfailures
)

echo "Installing Python and ROS development packages..."
sudo apt install -y "${PY_PKGS[@]}"

printf "‚úÖ Installation complete!\n\n"

echo "üí° To install a full ROS 2 distribution, run:"
echo "    sudo apt install ros-<distro>-desktop"
echo "  Replace <distro> with your desired version (e.g., humble, iron, galactic, foxy)."
